<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>р╕кр╕бр╕▒р╕Др╕гр╕кр╕бр╕▓р╕Кр╕┤р╕Б</title>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.46.0/dist/umd/supabase.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>body{font-family:Prompt, sans-serif;background:#f9fafb}</style>
</head>
<body class="min-h-screen flex items-center justify-center">
  <div class="w-full max-w-md p-6 bg-white rounded-xl shadow">
    <h1 class="text-xl font-bold text-center mb-4">ЁЯУЭ р╕кр╕бр╕▒р╕Др╕гр╕кр╕бр╕▓р╕Кр╕┤р╕Бр╕кр╕лр╕Бр╕гр╕Ур╣М</h1>

    <div class="space-y-3">
      <input id="first_name" placeholder="р╕Кр╕╖р╣Ир╕н" class="w-full border rounded px-3 py-2" />
      <input id="last_name" placeholder="р╕Щр╕▓р╕бр╕кр╕Бр╕╕р╕е" class="w-full border rounded px-3 py-2" />
      <input id="member_no" placeholder="р╣Ар╕ер╕Вр╕кр╕бр╕▓р╕Кр╕┤р╕Б" class="w-full border rounded px-3 py-2" />
      <input id="group_name" placeholder="р╕Бр╕ер╕╕р╣Ир╕б" class="w-full border rounded px-3 py-2" />
      <button id="btnRegister" class="w-full bg-green-600 text-white py-2 rounded">р╕кр╕бр╕▒р╕Др╕гр╕кр╕бр╕▓р╕Кр╕┤р╕Б</button>
    </div>
  </div>

<script>
/* = CONFIG = */
const SUPABASE_URL = "https://uqnqolexvdkdfzwzknzu.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVxbnFvbGV4dmRrZGZ6d3prbnp1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIwNDA4MjksImV4cCI6MjA3NzYxNjgyOX0.J-pGOOluMPDbDr6qwUSnGfJFlr-G9BTOSGNq42WSxZA";
const LIFF_ID = "1660910795-pVE6RZB3";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
/* = END CONFIG = */

let profile = null;
async function init() {
  await liff.init({ liffId: LIFF_ID });
  if (!liff.isLoggedIn()) await liff.login();
  profile = await liff.getProfile();
}
init();

document.getElementById("btnRegister").onclick = async () => {
  const first_name = document.getElementById("first_name").value.trim();
  const last_name  = document.getElementById("last_name").value.trim();
  const member_no  = document.getElementById("member_no").value.trim();
  const group_name = document.getElementById("group_name").value.trim();

  if (!first_name || !last_name || !member_no) {
    return Swal.fire("р╕Бр╕гр╕нр╕Бр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Др╕бр╣Ир╕Др╕гр╕Ъ", "р╕Бр╕гр╕╕р╕Ур╕▓р╕Бр╕гр╕нр╕Б р╕Кр╕╖р╣Ир╕н р╕Щр╕▓р╕бр╕кр╕Бр╕╕р╕е р╣Бр╕ер╕░р╣Ар╕ер╕Вр╕кр╕бр╕▓р╕Кр╕┤р╕Б", "warning");
  }

  Swal.fire({ title: "р╕Бр╕│р╕ер╕▒р╕Зр╕кр╕бр╕▒р╕Др╕г...", didOpen: () => Swal.showLoading(), allowOutsideClick:false });

  // р╕Хр╕гр╕зр╕Ир╣Ар╕ер╕Вр╕Лр╣Йр╕│
  const { data: exist } = await supabase.from("members").select("member_no").eq("member_no", member_no).maybeSingle();
  if (exist) {
    Swal.close();
    return Swal.fire("р╣Ар╕ер╕Вр╕кр╕бр╕▓р╕Кр╕┤р╕Бр╕Лр╣Йр╕│", "р╕Бр╕гр╕╕р╕Ур╕▓р╣Гр╕Кр╣Йр╣Ар╕ер╕Вр╕кр╕бр╕▓р╕Кр╕┤р╕Бр╕нр╕╖р╣Ир╕Щ", "error");
  }

  const payload = {
    line_user_id: profile.userId,
    line_display_name: profile.displayName,
    first_name, last_name, member_no, group_name,
    carry_forward: 0,
    purchase_year: 0
    // total_amount р╕Цр╣Йр╕▓р╕Хр╕▒р╣Йр╕Зр╣Ар╕Ыр╣Зр╕Щ generated stored р╕лр╕ер╕▒р╕З SQL р╕Ир╕░р╕Др╕│р╕Щр╕зр╕Ур╣Гр╕лр╣Йр╣Ар╕нр╕З
  };

  const { error } = await supabase.from("members").insert([payload]);
  Swal.close();
  if (error) {
    console.error("Register error:", error);
    return Swal.fire("р╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Ф", error.message, "error");
  }

  Swal.fire("р╕кр╕│р╣Ар╕гр╣Зр╕И", "р╕кр╕бр╕▒р╕Др╕гр╕кр╕бр╕▓р╕Кр╕┤р╕Бр╣Ар╕гр╕╡р╕вр╕Ър╕гр╣Йр╕нр╕в", "success").then(() => liff.closeWindow());
};
</script>
</body>
</html>
