<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>‡∏ã‡∏∑‡πâ‡∏≠‡∏´‡∏∏‡πâ‡∏ô‡∏Å‡∏±‡∏ö‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå</title>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.46.0/dist/umd/supabase.min.js"></script>
  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <!-- Tailwind -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
</head>

<body class="bg-gray-50 min-h-screen">
  <div class="max-w-md mx-auto p-6">
    <h1 class="text-2xl font-bold mb-3 text-center">‡∏ã‡∏∑‡πâ‡∏≠‡∏´‡∏∏‡πâ‡∏ô‡∏Å‡∏±‡∏ö‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå</h1>
    <p id="greeting" class="text-gray-600 mb-4 text-center">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö LINE...</p>

    <div class="bg-white p-4 rounded-xl shadow">
      <label class="block text-sm mb-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏∏‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠</label>
      <input id="sharesInput" type="number" min="1" value="1" class="border w-full p-2 rounded mb-4" />

      <label class="block text-sm mb-2">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏∏‡πâ‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
      <input id="priceInput" type="number" value="10" class="border w-full p-2 rounded mb-4" />

      <button id="genBtn" class="bg-green-600 text-white w-full p-2 rounded">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡πÑ‡∏õ LINE</button>

      <div id="resultBox" class="hidden mt-4">
        <p id="receiptText" class="font-medium mb-2 text-center"></p>
        <img id="qrImage" class="w-64 mx-auto mb-2 rounded" alt="PromptPay QR" />
        <p class="text-sm text-gray-600 text-center">‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô</p>
        <input id="proofFile" type="file" accept="image/*" class="mb-2 w-full" />
        <button id="uploadBtn" class="bg-blue-600 text-white w-full p-2 rounded">üì§ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô</button>
        <p id="statusText" class="text-sm mt-2 text-center"></p>
      </div>
    </div>
  </div>

<script>
/* ================= CONFIG ================= */
const LIFF_ID = "1660910795-4w2rdGn6"; // üëà LIFF ID
const SUPABASE_URL = "https://uqnqolexvdkdfzwzknzu.supabase.co"; // üëà Supabase URL
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVxbnFvbGV4dmRrZGZ6d3prbnp1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIwNDA4MjksImV4cCI6MjA3NzYxNjgyOX0.J-pGOOluMPDbDr6qwUSnGfJFlr-G9BTOSGNq42WSxZA"; // üëà anon key
const PAYEE_PHONE = "0936494961"; // üëà ‡πÄ‡∏ö‡∏≠‡∏£‡πå PromptPay
const SHARE_PRICE = 10; // ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏´‡∏∏‡πâ‡∏ô‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢
const STORAGE_BUCKET = "proofs"; // ‡∏ä‡∏∑‡πà‡∏≠ bucket Supabase
const FUNCTION_URL = "https://uqnqolexvdkdfzwzknzu.supabase.co/functions/v1/send-line-message"; // üëà URL Edge Function
/* ========================================== */

const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
let profile = null;

/* ‚úÖ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô LIFF */
async function init() {
  try {
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) return liff.login();
    profile = await liff.getProfile();
    document.getElementById("greeting").innerText = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ ${profile.displayName}`;
  } catch (err) {
    document.getElementById("greeting").innerText = "‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö LINE ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
    console.error(err);
  }
}
init();

/* ‚úÖ ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î "‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡πÑ‡∏õ LINE" */
document.getElementById("genBtn").addEventListener("click", async () => {
  const shares = +document.getElementById("sharesInput").value;
  const price = +document.getElementById("priceInput").value;
  if (!shares || shares <= 0) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏∏‡πâ‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
  const amount = shares * price;
  const qrUrl = `https://promptpay.io/${PAYEE_PHONE}/${amount}.png`;

  // ‡πÅ‡∏™‡∏î‡∏á QR ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ LIFF
  document.getElementById("receiptText").innerText =
    `‡∏¢‡∏≠‡∏î‡πÇ‡∏≠‡∏ô ${amount.toLocaleString()} ‡∏ö‡∏≤‡∏ó (${shares} ‡∏´‡∏∏‡πâ‡∏ô)`;
  document.getElementById("qrImage").src = qrUrl;
  document.getElementById("resultBox").classList.remove("hidden");

  // ‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Edge Function ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á Flex Message ‡∏°‡∏µ QR ‡πÉ‡∏ô LINE
  try {
    const res = await fetch(FUNCTION_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        userId: profile.userId,
        shares,
        amount
      })
    });
    const text = await res.text();
    console.log("‡∏™‡πà‡∏á Flex ‡πÅ‡∏à‡πâ‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠:", res.status, text);
    if (res.ok) alert("‚úÖ ‡∏™‡πà‡∏á‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÅ‡∏ä‡∏ó LINE ‡πÅ‡∏•‡πâ‡∏ß!");
  } catch (err) {
    console.error("‡∏™‡πà‡∏á Flex ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:", err);
  }
});

/* ‚úÖ ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô */
document.getElementById("uploadBtn").addEventListener("click", async () => {
  const file = document.getElementById("proofFile").files[0];
  if (!file) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô");
  const shares = +document.getElementById("sharesInput").value;
  const amount = shares * SHARE_PRICE;
  const userId = profile.userId;
  const displayName = profile.displayName;

  document.getElementById("statusText").innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...";
  document.getElementById("uploadBtn").disabled = true;

  try {
    // 1Ô∏è‚É£ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏õ Storage
    const ext = file.name.split(".").pop();
    const path = `${userId}_${Date.now()}.${ext}`;
    const { error: uploadError } = await supabaseClient
      .storage.from(STORAGE_BUCKET)
      .upload(path, file);
    if (uploadError) throw uploadError;

    // 2Ô∏è‚É£ ‡∏î‡∏∂‡∏á URL ‡∏Ç‡∏≠‡∏á‡∏£‡∏π‡∏õ
    const { data: publicData } = supabaseClient
      .storage.from(STORAGE_BUCKET)
      .getPublicUrl(path);
    const proofUrl = publicData.publicUrl;

    // 3Ô∏è‚É£ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°
    const { error: insertError } = await supabaseClient.from("transactions").insert([{
      line_user_id: userId,
      line_display_name: displayName,
      shares,
      amount,
      proof_url: proofUrl,
      status: "pending"
    }]);
    if (insertError) throw insertError;

    document.getElementById("statusText").innerText = "‚úÖ ‡∏™‡πà‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≤‡∏Å‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô";
  } catch (err) {
    console.error(err);
    document.getElementById("statusText").innerText = "‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message;
  } finally {
    document.getElementById("uploadBtn").disabled = false;
  }
});
</script>
</body>
</html>
