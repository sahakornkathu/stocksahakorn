<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå | ‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•</title>

  <!-- ‚úÖ Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.46.0/dist/umd/supabase.min.js"></script>
  <!-- ‚úÖ Tailwind -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>

<body class="bg-gray-50 min-h-screen">
  <div class="max-w-6xl mx-auto p-4">
    <h1 class="text-2xl font-bold text-center mb-6">üßë‚Äçüíº ‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå</h1>

    <div class="flex justify-between items-center mb-4">
      <h2 class="text-lg font-semibold">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏´‡∏∏‡πâ‡∏ô</h2>
      <button id="refreshBtn" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">üîÑ ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà</button>
    </div>

    <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
    <div class="overflow-x-auto bg-white p-4 rounded-xl shadow">
      <table class="w-full text-sm border border-gray-200">
        <thead class="bg-gray-100">
          <tr>
            <th class="p-2 border">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</th>
            <th class="p-2 border">‡πÄ‡∏•‡∏Ç‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</th>
            <th class="p-2 border">‡∏Å‡∏•‡∏∏‡πà‡∏°</th>
            <th class="p-2 border text-right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏∏‡πâ‡∏ô</th>
            <th class="p-2 border text-right">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô</th>
            <th class="p-2 border">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
            <th class="p-2 border text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
            <th class="p-2 border text-center">‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô</th>
            <th class="p-2 border text-center">‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</th>
          </tr>
        </thead>
        <tbody id="txTableBody"></tbody>
      </table>
    </div>
  </div>

<script>
/* ================= CONFIG ================= */
const SUPABASE_URL = "https://uqnqolexvdkdfzwzknzu.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVxbnFvbGV4dmRrZGZ6d3prbnp1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIwNDA4MjksImV4cCI6MjA3NzYxNjgyOX0.J-pGOOluMPDbDr6qwUSnGfJFlr-G9BTOSGNq42WSxZA";
const FUNCTION_URL = "https://uqnqolexvdkdfzwzknzu.supabase.co/functions/v1/send-line-message";
/* ========================================== */

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ================= LOAD DATA ================= */
async function loadTransactions() {
  const tableBody = document.getElementById("txTableBody");
  tableBody.innerHTML = `<tr><td colspan="9" class="text-center p-3 text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>`;

  // ‚úÖ JOIN ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ú‡πà‡∏≤‡∏ô Foreign Key
  const { data: transactions, error } = await supabase
    .from("transactions")
    .select(`
      id,
      line_user_id,
      line_display_name,
      shares,
      amount,
      proof_url,
      status,
      created_at,
      approved_at,
      members:members (
        first_name,
        last_name,
        member_no,
        group_name
      )
    `)
    .order("created_at", { ascending: false });

  if (error) {
    console.error("‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", error);
    tableBody.innerHTML = `<tr><td colspan="9" class="text-center text-red-500 p-3">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß (${error.message})</td></tr>`;
    return;
  }

  if (!transactions || transactions.length === 0) {
    tableBody.innerHTML = `<tr><td colspan="9" class="text-center p-3 text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</td></tr>`;
    return;
  }

  tableBody.innerHTML = transactions.map(tx => `
    <tr class="border-b hover:bg-gray-50">
      <td class="p-2 border">${tx.members?.first_name ?? '-'} ${tx.members?.last_name ?? ''}</td>
      <td class="p-2 border">${tx.members?.member_no ?? '-'}</td>
      <td class="p-2 border">${tx.members?.group_name ?? '-'}</td>
      <td class="p-2 border text-right">${tx.shares}</td>
      <td class="p-2 border text-right">${Number(tx.amount).toLocaleString()} ‡∏ö‡∏≤‡∏ó</td>
      <td class="p-2 border">${new Date(tx.created_at).toLocaleDateString("th-TH")}</td>
      <td class="p-2 border text-center">
        ${tx.status === 'approved'
          ? '<span class="text-green-600 font-semibold">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</span>'
          : '<span class="text-yellow-600">‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</span>'}
      </td>
      <td class="p-2 border text-center">
        ${tx.proof_url
          ? `<a href="${tx.proof_url}" target="_blank" class="text-blue-600 underline">‡∏î‡∏π‡∏™‡∏•‡∏¥‡∏õ</a>`
          : '-'}
      </td>
      <td class="p-2 border text-center">
        ${
          tx.status !== 'approved'
            ? `<button class="bg-green-600 text-white px-2 py-1 rounded hover:bg-green-700" onclick="approveTx('${tx.id}', '${tx.line_user_id}', '${tx.members?.first_name ?? ''} ${tx.members?.last_name ?? ''}', ${tx.amount})">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>`
            : `<span class="text-gray-400">‚úîÔ∏è</span>`
        }
      </td>
    </tr>
  `).join("");
}

/* ================= APPROVE FUNCTION ================= */
async function approveTx(txId, userId, memberName, amount) {
  if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á ${memberName}?`)) return;

  // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏ô Supabase
  const { error } = await supabase
    .from("transactions")
    .update({ status: "approved", approved_at: new Date().toISOString() })
    .eq("id", txId);

  if (error) {
    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏ì‡∏∞‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥: " + error.message);
    return;
  }

  // ‚úÖ ‡∏™‡πà‡∏á Flex Message ‡πÅ‡∏à‡πâ‡∏á‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
  try {
    await fetch(FUNCTION_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        userId: userId,
        memberName: memberName,
        amount: amount,
        mode: "approved_success"
      })
    });
    alert("‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  } catch (err) {
    alert("‡∏™‡πà‡∏á Flex Message ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: " + err.message);
  }

  loadTransactions();
}

/* ================= INITIALIZE ================= */
document.getElementById("refreshBtn").addEventListener("click", loadTransactions);
loadTransactions();
</script>
</body>
</html>
