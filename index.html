<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>‡∏ã‡∏∑‡πâ‡∏≠‡∏´‡∏∏‡πâ‡∏ô</title>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.46.0/dist/umd/supabase.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>body{font-family:Prompt, sans-serif;background:#f4f6f8}</style>
</head>
<body class="min-h-screen flex items-center justify-center">
  <div class="w-full max-w-lg space-y-4 p-4">
    <div class="bg-white p-4 rounded-xl shadow text-center">
      <h1 class="text-xl font-bold">ü™ô ‡∏ã‡∏∑‡πâ‡∏≠‡∏´‡∏∏‡πâ‡∏ô‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå</h1>
      <p id="greet" class="text-sm text-gray-500 mt-1">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
    </div>

    <div id="memberCard" class="bg-white p-4 rounded-xl shadow hidden">
      <p><b id="memberName">-</b></p>
      <p>‡πÄ‡∏•‡∏Ç‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å: <span id="memberNo">-</span></p>
      <p>‡∏Å‡∏•‡∏∏‡πà‡∏°: <span id="memberGroup">-</span></p>
      <hr class="my-2"/>
      <p>‡∏¢‡∏≠‡∏î‡∏¢‡∏Å‡∏°‡∏≤: <span id="carryForward">0</span> ‡∏ö‡∏≤‡∏ó</p>
      <p>‡∏¢‡∏≠‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡∏õ‡∏µ‡∏ô‡∏µ‡πâ: <span id="purchaseYear">0</span> ‡∏ö‡∏≤‡∏ó</p>
      <p class="font-bold">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: <span id="totalAmount">0</span> ‡∏ö‡∏≤‡∏ó</p>
    </div>

    <div class="bg-white p-4 rounded-xl shadow">
      <label class="font-semibold">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
      <input id="amount" type="number" min="100" step="100" class="w-full border rounded p-2 mt-2" placeholder="‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ 100 ‡∏ö‡∏≤‡∏ó" />
      <div class="flex gap-2 mt-3">
        <button id="btnCheckout" class="flex-1 bg-green-600 text-white rounded py-2">‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏™‡∏•‡∏¥‡∏õ</button>
        <button id="btnClear" class="flex-1 bg-gray-300 rounded py-2">‡∏•‡πâ‡∏≤‡∏á</button>
      </div>
      <p class="text-xs text-gray-500 mt-2">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 20,000 ‡∏ö‡∏≤‡∏ó/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß)</p>
    </div>

    <div id="uploadArea" class="bg-white p-4 rounded-xl shadow hidden">
      <p class="font-semibold">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ</p>
      <input id="fileProof" type="file" accept="image/*" class="w-full mt-2" />
      <button id="btnSendProof" class="w-full bg-blue-600 text-white rounded py-2 mt-3">‡∏™‡πà‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô</button>
    </div>
  </div>

<script>
/* = CONFIG = */
const SUPABASE_URL = "https://uqnqolexvdkdfzwzknzu.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVxbnFvbGV4dmRrZGZ6d3prbnp1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIwNDA4MjksImV4cCI6MjA3NzYxNjgyOX0.J-pGOOluMPDbDr6qwUSnGfJFlr-G9BTOSGNq42WSxZA";
const LIFF_ID = "1660910795-4w2rdGn6";
const FUNCTION_URL = "https://uqnqolexvdkdfzwzknzu.supabase.co/functions/v1/send-line-message"; // e.g. https://<project>.functions.supabase.co/send-line-message
const PROMPTPAY_NO = "0936494961";
const MIN_TOTAL = 100;
const MONTHLY_MAX = 20000;
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
/* = END CONFIG = */

let profile = null;
let currentTx = null; // hold inserted transaction id
async function init(){
  await liff.init({ liffId: LIFF_ID });
  if (!liff.isLoggedIn()) await liff.login();
  profile = await liff.getProfile();
  document.getElementById("greet").innerText = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ ${profile.displayName}`;
  await loadMember();
}
init();

async function loadMember(){
  const { data: member, error } = await supabase.from("members").select("*").eq("line_user_id", profile.userId).maybeSingle();
  if (error) { console.error(error); Swal.fire("‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", error.message, "error"); return; }
  if (!member) {
    Swal.fire("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏Å‡πà‡∏≠‡∏ô", "warning").then(()=> liff.openWindow({url: "register.html"}));
    return;
  }
  document.getElementById("memberCard").classList.remove("hidden");
  document.getElementById("memberName").innerText = `${member.first_name || ''} ${member.last_name || ''}`;
  document.getElementById("memberNo").innerText = member.member_no ?? '-';
  document.getElementById("memberGroup").innerText = member.group_name ?? '-';
  document.getElementById("carryForward").innerText = (member.carry_forward ?? 0).toLocaleString();
  document.getElementById("purchaseYear").innerText = (member.purchase_year ?? 0).toLocaleString();
  const total = member.total_amount ?? ((member.carry_forward ?? 0) + (member.purchase_year ?? 0));
  document.getElementById("totalAmount").innerText = total.toLocaleString();
}

document.getElementById("btnClear").onclick = () => {
  document.getElementById("amount").value = "";
  document.getElementById("fileProof").value = "";
  document.getElementById("uploadArea").classList.add("hidden");
  Swal.fire("‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß", "", "info");
};

document.getElementById("btnCheckout").onclick = async () => {
  const amount = Number(document.getElementById("amount").value);
  if (!amount || amount < MIN_TOTAL) return Swal.fire("‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô", `‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ ${MIN_TOTAL} ‡∏ö‡∏≤‡∏ó`, "warning");

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏¢‡∏≠‡∏î‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
  const now = new Date();
  const y = now.getFullYear();
  const m = now.getMonth(); // 0-index
  const start = new Date(y, m, 1).toISOString();
  const end = new Date(y, m+1, 1).toISOString();

  const { data: approved, error: apperr } = await supabase
    .from("transactions")
    .select("amount")
    .eq("line_user_id", profile.userId)
    .eq("status","approved")
    .gte("created_at", start)
    .lt("created_at", end);

  if (apperr) { console.error(apperr); Swal.fire("‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", apperr.message, "error"); return; }
  const sumApproved = (approved || []).reduce((s,r)=> s + Number(r.amount || 0), 0);
  if (sumApproved + amount > MONTHLY_MAX) {
    return Swal.fire("‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç", `‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ ${sumApproved.toLocaleString()} ‡∏ö‡∏≤‡∏ó‡πÅ‡∏•‡πâ‡∏ß\n‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏Å‡∏¥‡∏ô ${MONTHLY_MAX.toLocaleString()} ‡∏ö‡∏≤‡∏ó/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô`, "warning");
  }

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á transaction status pending -> we will set slip_uploaded after uploading proof
  Swal.fire({ title: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠...", didOpen: ()=> Swal.showLoading(), allowOutsideClick:false});
  const shares = Math.round(amount / 10); // if share price = 10
  const { data, error } = await supabase.from("transactions").insert([{
    line_user_id: profile.userId,
    line_display_name: profile.displayName,
    shares,
    amount,
    status: "pending"
  }]).select().single();

  Swal.close();
  if (error) { console.error(error); return Swal.fire("‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", error.message, "error"); }

  currentTx = data.id;
  // show upload area
  document.getElementById("uploadArea").classList.remove("hidden");
  Swal.fire("‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ", "success");
};

document.getElementById("btnSendProof").onclick = async () => {
  if (!currentTx) return Swal.fire("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏Å‡πà‡∏≠‡∏ô", "warning");
  const file = document.getElementById("fileProof").files[0];
  if (!file) return Swal.fire("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏•‡∏¥‡∏õ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏ô‡∏ö", "warning");

  Swal.fire({ title: "‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ...", didOpen: ()=> Swal.showLoading(), allowOutsideClick:false});
  const path = `${profile.userId}/${Date.now()}_${file.name}`;
  const { error: uploadError } = await supabase.storage.from("proofs").upload(path, file);
  if (uploadError) { Swal.close(); return Swal.fire("‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß", uploadError.message, "error"); }
  const proofUrl = `${SUPABASE_URL}/storage/v1/object/public/proofs/${path}`;

  // update transaction -> mark slip_uploaded and add proof_url
  const { error } = await supabase.from("transactions").update({
    proof_url: proofUrl,
    status: "slip_uploaded"
  }).eq("id", currentTx);

  if (error) { Swal.close(); return Swal.fire("‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", error.message, "error"); }

  // call edge function to send flex to user
  try {
    await fetch(FUNCTION_URL, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({
        userId: profile.userId,
        memberName: profile.displayName,
        amount: Number(document.getElementById("amount").value),
        proofUrl,
        mode: "slip_uploaded",
        txId: currentTx
      })
    });
  } catch (e) {
    console.warn("Edge function call failed:", e);
  }

  Swal.close();
  Swal.fire("‡∏™‡πà‡∏á‡∏™‡∏•‡∏¥‡∏õ‡πÅ‡∏•‡πâ‡∏ß", "‡∏£‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö", "success").then(()=> liff.closeWindow());
};
</script>
</body>
</html>
