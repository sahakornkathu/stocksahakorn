<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡∏ã‡∏∑‡πâ‡∏≠‡∏´‡∏∏‡πâ‡∏ô‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå</title>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- LIFF -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    body { font-family: sans-serif; background:#f4f6f8; }
    .card {
      max-width:420px;
      margin:40px auto;
      background:#fff;
      padding:20px;
      border-radius:10px;
      box-shadow:0 2px 10px rgba(0,0,0,.1);
    }
    input, select, button {
      width:100%;
      padding:10px;
      margin-top:10px;
    }
    button {
      background:#2e7d32;
      color:#fff;
      border:none;
      border-radius:6px;
      cursor:pointer;
    }
    .ok { color:green; margin-top:8px; }
  </style>
</head>
<body>

<div class="card">
  <h3>üìà ‡∏ã‡∏∑‡πâ‡∏≠‡∏´‡∏∏‡πâ‡∏ô‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå</h3>

  <label>‡πÄ‡∏•‡∏Ç‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏´‡∏∏‡πâ‡∏ô</label>
  <input id="id_customer" type="number" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏´‡∏∏‡πâ‡∏ô">

  <div id="memberInfo" class="ok"></div>

  <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏∏‡πâ‡∏ô</label>
  <select id="stock"></select>

  <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏∏‡πâ‡∏ô</label>
  <input id="qty" type="number" min="1" value="1">

  <button onclick="buyStock()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ã‡∏∑‡πâ‡∏≠‡∏´‡∏∏‡πâ‡∏ô</button>
</div>

<script>
/* ================= CONFIG ================= */
const SUPABASE_URL = "https://ttottijljxoinptmhgtu.supabase.co"
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0b3R0aWpsanhvaW5wdG1oZ3R1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMTYxODQsImV4cCI6MjA3MzU5MjE4NH0.XnIf3xLzSbZDwFVKWjLTCiF4jnnDMQ1W95EI-v6F-3Y"
const LIFF_ID = "1660910795-lDlxC6Wy"
/* ========================================= */

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

let lineUserId = null
let member = null

/* ---------- INIT ---------- */
async function init() {
  await liff.init({ liffId: LIFF_ID })

  if (!liff.isInClient()) {
    alert("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô LINE")
    return
  }

  const profile = await liff.getProfile()
  lineUserId = profile.userId

  loadStocks()
}
init()

/* ---------- LOAD STOCK ---------- */
async function loadStocks() {
  const { data, error } = await sb
    .from('stocks')
    .select('*')
    .eq('is_active', true)

  if (error) {
    alert(error.message)
    return
  }

  const sel = document.getElementById('stock')
  sel.innerHTML = ""

  data.forEach(s => {
    const o = document.createElement('option')
    o.value = s.stock_id
    o.text = `${s.stock_name} (${s.price_per_unit} ‡∏ö‡∏≤‡∏ó)`
    o.dataset.price = s.price_per_unit
    sel.appendChild(o)
  })
}

/* ---------- CHECK MEMBER ---------- */
document.getElementById('id_customer').addEventListener('change', checkMember)

async function checkMember() {
  const id = document.getElementById('id_customer').value

  const { data, error } = await sb
    .from('members')
    .select('id_customer,prefix,name,lastname,uid')
    .eq('id_customer', id)
    .single()

  if (error || !data) {
    alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å")
    return
  }

  if (data.uid !== lineUserId) {
    alert("‚ùå LINE ‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏•‡∏Ç‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏´‡∏∏‡πâ‡∏ô")
    return
  }

  member = data
  document.getElementById('memberInfo').innerText =
    `üë§ ${data.prefix}${data.name} ${data.lastname}`
}

/* ---------- BUY STOCK ---------- */
async function buyStock() {
  if (!member) {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏Å‡πà‡∏≠‡∏ô")
    return
  }

  const stockSel = document.getElementById('stock')
  const stock_id = stockSel.value
  const price = stockSel.selectedOptions[0].dataset.price
  const qty = parseInt(document.getElementById('qty').value)

  // create order
  const { data: order, error: e1 } = await sb
    .from('stock_orders')
    .insert({ id_customer: member.id_customer })
    .select()
    .single()

  if (e1) {
    alert(e1.message)
    return
  }

  // create detail
  const { error: e2 } = await sb
    .from('stock_order_details')
    .insert({
      order_id: order.order_id,
      stock_id,
      quantity: qty,
      price_per_unit: price
    })

  if (e2) {
    alert(e2.message)
    return
  }

  alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏´‡∏∏‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ (‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô)")
}
</script>

</body>
</html>
