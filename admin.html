<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin - ‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.46.0/dist/umd/supabase.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>body{font-family:Prompt, sans-serif;background:#f4f6f8}</style>
</head>
<body class="min-h-screen p-6">
  <div class="max-w-5xl mx-auto">
    <h1 class="text-2xl font-bold text-green-700 mb-4">üõ† ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏´‡∏∏‡πâ‡∏ô (Admin)</h1>
    <div id="txList" class="space-y-4"></div>
  </div>

<script>
/* = CONFIG = */
const SUPABASE_URL = "REPLACE_WITH_YOUR_SUPABASE_URL";
const SUPABASE_ANON_KEY = "REPLACE_WITH_YOUR_SUPABASE_ANON_KEY";
const FUNCTION_URL = "REPLACE_WITH_YOUR_EDGE_FUNCTION_URL";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
/* = END CONFIG = */

async function loadTransactions(){
  // join members fields
  const { data, error } = await supabase
    .from("transactions")
    .select(`
      *,
      members (
        first_name,
        last_name,
        member_no,
        group_name
      )
    `)
    .order("created_at", { ascending: false });

  if (error) return Swal.fire("‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", error.message, "error");

  const el = document.getElementById("txList");
  el.innerHTML = "";
  if (!data || data.length === 0) { el.innerHTML = `<p class="text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</p>`; return; }

  data.forEach(tx => {
    const card = document.createElement("div");
    card.className = "bg-white p-4 rounded-xl shadow flex justify-between items-start";
    const left = document.createElement("div");
    left.innerHTML = `
      <div class="font-semibold">${tx.members?.first_name || '-'} ${tx.members?.last_name || ''}</div>
      <div class="text-sm text-gray-500">‡πÄ‡∏•‡∏Ç‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å: ${tx.members?.member_no || '-'} ‚Ä¢ ‡∏Å‡∏•‡∏∏‡πà‡∏°: ${tx.members?.group_name || '-'}</div>
      <div class="mt-2">‡∏´‡∏∏‡πâ‡∏ô: ${tx.shares} ‚Ä¢ ‡∏¢‡∏≠‡∏î: ${Number(tx.amount).toLocaleString()} ‡∏ö‡∏≤‡∏ó</div>
      <div class="text-xs text-gray-400 mt-1">‡πÄ‡∏ß‡∏•‡∏≤: ${new Date(tx.created_at).toLocaleString()}</div>
    `;
    const right = document.createElement("div");
    right.className = "flex flex-col gap-2 items-end";
    if (tx.proof_url) right.innerHTML += `<a href="${tx.proof_url}" target="_blank" class="text-blue-600 underline text-sm">üì∑ ‡∏î‡∏π‡∏™‡∏•‡∏¥‡∏õ</a>`;
    right.innerHTML += `<div class="text-sm font-medium mt-2 ${tx.status === 'approved' ? 'text-green-600' : tx.status === 'rejected' ? 'text-red-600' : 'text-yellow-600'}">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${tx.status}</div>`;

    if (tx.status === "slip_uploaded" || tx.status === "pending") {
      const btnApprove = document.createElement("button");
      btnApprove.className = "bg-green-600 text-white px-3 py-1 rounded text-sm";
      btnApprove.innerText = "‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥";
      btnApprove.onclick = () => approveTx(tx.id, tx.line_user_id, `${tx.members?.first_name || ''} ${tx.members?.last_name || ''}`, tx.amount);
      const btnReject = document.createElement("button");
      btnReject.className = "bg-red-600 text-white px-3 py-1 rounded text-sm";
      btnReject.innerText = "‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å";
      btnReject.onclick = () => rejectTx(tx.id, tx.line_user_id, `${tx.members?.first_name || ''} ${tx.members?.last_name || ''}`, tx.amount);
      right.appendChild(btnApprove);
      right.appendChild(btnReject);
    }

    card.appendChild(left);
    card.appendChild(right);
    el.appendChild(card);
  });
}

async function approveTx(id, userId, name, amount){
  const res = await Swal.fire({ title: "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥?", html: `<b>${name}</b><br/>‡∏¢‡∏≠‡∏î ${Number(amount).toLocaleString()} ‡∏ö‡∏≤‡∏ó`, icon: "question", showCancelButton:true });
  if (!res.isConfirmed) return;
  const { error } = await supabase.from("transactions").update({ status: "approved", approved_at: new Date().toISOString() }).eq("id", id);
  if (error) return Swal.fire("‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", error.message, "error");

  // call edge function to notify user
  try {
    await fetch(FUNCTION_URL, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ userId, memberName: name, amount, mode: "approved_success", txId: id })
    });
  } catch (e) { console.warn("Edge call failed", e); }

  Swal.fire("‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß", "", "success");
  loadTransactions();
}

async function rejectTx(id, userId, name, amount){
  const { value: reason } = await Swal.fire({ title: "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á", input: "text", inputPlaceholder: "‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏• (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)", showCancelButton:true });
  if (reason === undefined) return;
  const { error } = await supabase.from("transactions").update({ status: "rejected", reason }).eq("id", id);
  if (error) return Swal.fire("‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", error.message, "error");

  // notify
  try {
    await fetch(FUNCTION_URL, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ userId, memberName: name, amount, mode: "rejected_slip", reason, txId: id })
    });
  } catch (e) { console.warn("Edge call failed", e); }

  Swal.fire("‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß", "", "success");
  loadTransactions();
}

// initial load
loadTransactions();
</script>
</body>
</html>
