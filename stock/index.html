<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>‡∏ã‡∏∑‡πâ‡∏≠‡∏´‡∏∏‡πâ‡∏ô‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: sans-serif; background:#f5f5f5; }
    .card { background:#fff; padding:20px; max-width:420px; margin:40px auto; border-radius:10px; }
    input, select, button {
      width:100%; padding:10px; margin-top:10px;
    }
    button { background:#2e7d32; color:#fff; border:none; border-radius:6px; }
  </style>
</head>
<body>

<div class="card">
  <h2>üìà ‡∏ã‡∏∑‡πâ‡∏≠‡∏´‡∏∏‡πâ‡∏ô‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå</h2>

  <label>‡πÄ‡∏•‡∏Ç‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏´‡∏∏‡πâ‡∏ô</label>
  <input id="id_customer" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏´‡∏∏‡πâ‡∏ô" />

  <div id="memberInfo" style="margin-top:10px;color:#2e7d32;"></div>

  <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏∏‡πâ‡∏ô</label>
  <select id="stock"></select>

  <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏∏‡πâ‡∏ô</label>
  <input type="number" id="qty" value="1" min="1" />

  <button onclick="buyStock()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ã‡∏∑‡πâ‡∏≠‡∏´‡∏∏‡πâ‡∏ô</button>
</div>

<script>
const supabase = supabase.createClient(
  'https://ttottijljxoinptmhgtu.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0b3R0aWpsanhvaW5wdG1oZ3R1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMTYxODQsImV4cCI6MjA3MzU5MjE4NH0.XnIf3xLzSbZDwFVKWjLTCiF4jnnDMQ1W95EI-v6F-3Y'
)

let lineUserId = null
let member = null

async function init() {
  await liff.init({ liffId: '1660910795-lDlxC6Wy' })
  const profile = await liff.getProfile()
  lineUserId = profile.userId

  loadStocks()
}
init()

async function loadStocks() {
  const { data } = await supabase
    .from('stocks')
    .select('*')
    .eq('is_active', true)

  const select = document.getElementById('stock')
  data.forEach(s => {
    const opt = document.createElement('option')
    opt.value = s.stock_id
    opt.text = `${s.stock_name} (${s.price_per_unit} ‡∏ö‡∏≤‡∏ó)`
    select.appendChild(opt)
  })
}

document.getElementById('id_customer').addEventListener('change', checkMember)

async function checkMember() {
  const id = document.getElementById('id_customer').value

  const { data } = await supabase
    .from('members')
    .select('*')
    .eq('id_customer', id)
    .single()

  if (!data || data.uid !== lineUserId) {
    alert('‚ùå ‡πÄ‡∏•‡∏Ç‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏´‡∏∏‡πâ‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö LINE')
    return
  }

  member = data
  document.getElementById('memberInfo').innerText =
    `üë§ ${data.prefix}${data.name} ${data.lastname}`
}

async function buyStock() {
  if (!member) {
    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏Å‡πà‡∏≠‡∏ô')
    return
  }

  const stock_id = document.getElementById('stock').value
  const qty = document.getElementById('qty').value

  // 1. create order
  const { data: order } = await supabase
    .from('stock_orders')
    .insert({ id_customer: member.id_customer })
    .select()
    .single()

  // 2. create detail
  await supabase.from('stock_order_details').insert({
    order_id: order.order_id,
    stock_id,
    quantity: qty,
    price_per_unit: document.getElementById('stock').selectedOptions[0]
      .text.match(/\((.*) ‡∏ö‡∏≤‡∏ó\)/)[1]
  })

  alert('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏´‡∏∏‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß (‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô)')
}
</script>

</body>
</html>
