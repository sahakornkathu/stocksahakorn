<!doctype html>
<html lang="th">
>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>р╕кр╕лр╕Бр╕гр╕Ур╣М | р╕кр╕бр╕▒р╕Др╕гр╕кр╕бр╕▓р╕Кр╕┤р╕Б</title>

  <!-- тЬЕ LIFF -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <!-- тЬЕ Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.46.0/dist/umd/supabase.min.js"></script>

  <!-- тЬЕ SweetAlert -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- тЬЕ Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      font-family: 'Prompt', sans-serif;
      background: #f9fafb;
      color: #111827;
    }
    .card {
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.05);
    }
  </style>
</head>

<body class="min-h-screen flex flex-col items-center justify-center">
  <div class="w-full max-w-md card space-y-4">
    <h1 class="text-2xl font-bold text-center text-green-600">ЁЯУЭ р╕кр╕бр╕▒р╕Др╕гр╕кр╕бр╕▓р╕Кр╕┤р╕Бр╕кр╕лр╕Бр╕гр╕Ур╣М</h1>

    <div class="space-y-2">
      <label class="block font-semibold">р╕Кр╕╖р╣Ир╕н</label>
      <input id="first_name" type="text" placeholder="р╕Кр╕╖р╣Ир╕нр╕Ир╕гр╕┤р╕З" class="w-full border rounded px-3 py-2">
    </div>

    <div class="space-y-2">
      <label class="block font-semibold">р╕Щр╕▓р╕бр╕кр╕Бр╕╕р╕е</label>
      <input id="last_name" type="text" placeholder="р╕Щр╕▓р╕бр╕кр╕Бр╕╕р╕е" class="w-full border rounded px-3 py-2">
    </div>

    <div class="space-y-2">
      <label class="block font-semibold">р╣Ар╕ер╕Вр╕кр╕бр╕▓р╕Кр╕┤р╕Б</label>
      <input id="member_no" type="text" placeholder="р╣Ар╕Кр╣Ир╕Щ 00123" class="w-full border rounded px-3 py-2">
    </div>

    <div class="space-y-2">
      <label class="block font-semibold">р╕Бр╕ер╕╕р╣Ир╕б</label>
      <input id="group_name" type="text" placeholder="р╣Ар╕Кр╣Ир╕Щ р╕Бр╕ер╕╕р╣Ир╕бр╕Чр╕╡р╣И 1" class="w-full border rounded px-3 py-2">
    </div>

    <button id="btnRegister" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded">тЬЕ р╕кр╕бр╕▒р╕Др╕гр╕кр╕бр╕▓р╕Кр╕┤р╕Б</button>
  </div>

  <script>
    /* ============ CONFIG ============ */
    const SUPABASE_URL = "https://uqnqolexvdkdfzwzknzu.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVxbnFvbGV4dmRrZGZ6d3prbnp1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIwNDA4MjksImV4cCI6MjA3NzYxNjgyOX0.J-pGOOluMPDbDr6qwUSnGfJFlr-G9BTOSGNq42WSxZA";
    const LIFF_ID = "1660910795-4w2rdGn6";

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    let profile = null;

    /* ============ INIT ============ */
    async function init() {
      await liff.init({ liffId: LIFF_ID });
      if (!liff.isLoggedIn()) return liff.login();
      profile = await liff.getProfile();
      console.log("тЬЕ LINE Profile:", profile);
    }

    init();

    /* ============ REGISTER ============ */
    document.getElementById("btnRegister").onclick = async () => {
      const first_name = document.getElementById("first_name").value.trim();
      const last_name = document.getElementById("last_name").value.trim();
      const member_no = document.getElementById("member_no").value.trim();
      const group_name = document.getElementById("group_name").value.trim();

      if (!first_name || !last_name || !member_no) {
        return Swal.fire("тЪая╕П р╕Бр╕гр╕нр╕Бр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Др╕бр╣Ир╕Др╕гр╕Ъ", "р╕Бр╕гр╕╕р╕Ур╕▓р╕Бр╕гр╕нр╕Бр╕Кр╕╖р╣Ир╕н р╕Щр╕▓р╕бр╕кр╕Бр╕╕р╕е р╣Бр╕ер╕░р╣Ар╕ер╕Вр╕кр╕бр╕▓р╕Кр╕┤р╕Б", "warning");
      }

      Swal.fire({ title: "р╕Бр╕│р╕ер╕▒р╕Зр╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ...", allowOutsideClick: false, didOpen: () => Swal.showLoading() });

      // р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓р╕бр╕╡р╣Ар╕ер╕Вр╕кр╕бр╕▓р╕Кр╕┤р╕Бр╕Лр╣Йр╕│р╣Др╕лр╕б
      const { data: existing } = await supabase
        .from("members")
        .select("member_no")
        .eq("member_no", member_no)
        .maybeSingle();

      if (existing) {
        Swal.close();
        return Swal.fire("тЭМ р╕бр╕╡р╣Ар╕ер╕Вр╕кр╕бр╕▓р╕Кр╕┤р╕Бр╕Щр╕╡р╣Йр╕нр╕вр╕╣р╣Ир╣Бр╕ер╣Йр╕з", "р╕Бр╕гр╕╕р╕Ур╕▓р╣Гр╕Кр╣Йр╣Ар╕ер╕Вр╕нр╕╖р╣Ир╕Щ", "error");
      }

      const { error } = await supabase.from("members").insert([{
        line_user_id: profile.userId,
        line_display_name: profile.displayName,
        first_name,
        last_name,
        member_no,
        group_name,
        carry_forward: 0,
        purchase_year: 0,
        total_amount: 0
      }]);

      Swal.close();

      if (error) {
        console.error("Register error:", error);
        return Swal.fire("р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Ф", error.message, "error");
      }

      Swal.fire("ЁЯОЙ р╕кр╕бр╕▒р╕Др╕гр╕кр╕│р╣Ар╕гр╣Зр╕И", "р╕Др╕╕р╕Ур╣Др╕Фр╣Йр╕кр╕бр╕▒р╕Др╕гр╕кр╕бр╕▓р╕Кр╕┤р╕Бр╣Ар╕гр╕╡р╕вр╕Ър╕гр╣Йр╕нр╕вр╣Бр╕ер╣Йр╕з", "success")
        .then(() => liff.closeWindow());
    };
  </script>
</body>
</html>
