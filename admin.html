<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå | ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</title>

  <!-- CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.46.0/dist/umd/supabase.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;600;700&display=swap');
    body {
      font-family: 'Prompt', sans-serif;
      background: linear-gradient(135deg, #f9fafb, #f0fdf4);
      color: #1e293b;
      transition: all 0.3s ease;
    }

    .dark-mode {
      background: linear-gradient(135deg, #0f172a, #1e293b);
      color: #f1f5f9;
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .title {
      font-size: 1.75rem;
      font-weight: 700;
      background: linear-gradient(90deg, #16a34a, #0ea5e9);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    /* Search Bar */
    .search-box {
      background: rgba(255, 255, 255, 0.85);
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05);
      padding: 0.75rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      transition: all 0.3s;
    }
    .search-box input {
      flex: 1;
      border: none;
      outline: none;
      background: transparent;
      font-size: 1rem;
      color: inherit;
    }
    .dark-mode .search-box {
      background: rgba(30, 41, 59, 0.7);
      border: 1px solid rgba(148, 163, 184, 0.2);
    }

    /* Card */
    .card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 16px;
      padding: 1.25rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
      transition: transform 0.25s, background 0.3s;
    }
    .card:hover {
      transform: translateY(-4px);
    }
    .dark-mode .card {
      background: rgba(30, 41, 59, 0.8);
      border: 1px solid rgba(148, 163, 184, 0.2);
    }

    /* Status Badge */
    .status {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.85rem;
      font-weight: 600;
      margin-top: 0.25rem;
    }
    .status-pending { background: #fef9c3; color: #854d0e; }
    .status-slip_uploaded { background: #dbeafe; color: #1e40af; }
    .status-approved { background: #dcfce7; color: #166534; }
    .status-rejected { background: #fee2e2; color: #991b1b; }

    /* Buttons */
    .btn {
      padding: 0.5rem 1rem;
      border-radius: 8px;
      font-weight: 500;
      font-size: 0.9rem;
      transition: transform 0.2s, background 0.2s;
    }
    .btn:hover { transform: scale(1.05); }
    .btn-approve { background: #16a34a; color: white; }
    .btn-approve:hover { background: #15803d; }
    .btn-reject { background: #dc2626; color: white; }
    .btn-reject:hover { background: #b91c1c; }
    .btn-refresh { background: #0ea5e9; color: white; }
    .btn-refresh:hover { background: #0284c7; }

    /* Responsive */
    @media (max-width: 640px) {
      .card { padding: 1rem; }
      .title { font-size: 1.4rem; }
      .header { flex-direction: column; gap: 0.5rem; align-items: flex-start; }
    }
  </style>
</head>

<body class="min-h-screen">
  <div class="max-w-5xl mx-auto p-5">
    <div class="header">
      <h1 class="title">üõ† ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏´‡∏∏‡πâ‡∏ô</h1>
      <div class="flex gap-2">
        <button id="refreshBtn" class="btn btn-refresh">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
        <button id="toggleMode" class="btn bg-gray-800 text-white">üåô</button>
      </div>
    </div>

    <!-- Search -->
    <div class="search-box mb-6">
      <span>üîç</span>
      <input id="searchInput" type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å ‡∏´‡∏£‡∏∑‡∏≠ ‡∏Å‡∏•‡∏∏‡πà‡∏°..." />
    </div>

    <!-- Transaction List -->
    <div id="txList" class="space-y-4"></div>
  </div>

<script>
/* CONFIG */
const SUPABASE_URL = "https://uqnqolexvdkdfzwzknzu.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVxbnFvbGV4dmRrZGZ6d3prbnp1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIwNDA4MjksImV4cCI6MjA3NzYxNjgyOX0.J-pGOOluMPDbDr6qwUSnGfJFlr-G9BTOSGNq42WSxZA";
const FUNCTION_URL = `${SUPABASE_URL}/functions/v1/send-line-message`;
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* Theme Toggle */
document.getElementById("toggleMode").onclick = () => {
  document.body.classList.toggle("dark-mode");
  document.getElementById("toggleMode").textContent =
    document.body.classList.contains("dark-mode") ? "‚òÄÔ∏è" : "üåô";
};

/* Load Transactions */
async function loadTransactions(keyword = "") {
  const { data, error } = await supabase
    .from("transactions")
    .select(`*, members (first_name, last_name, group_name)`)
    .order("created_at", { ascending: false });

  const list = document.getElementById("txList");
  list.innerHTML = "";

  if (error) return Swal.fire("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", error.message, "error");

  const filtered = keyword
    ? data.filter(t =>
        (t.members?.first_name + " " + t.members?.last_name).toLowerCase().includes(keyword.toLowerCase()) ||
        (t.members?.group_name || "").toLowerCase().includes(keyword.toLowerCase())
      )
    : data;

  if (!filtered.length) {
    list.innerHTML = `<p class="text-center text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</p>`;
    return;
  }

  filtered.forEach(tx => {
    const statusClass = `status-${tx.status}`;

    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      <div class="flex justify-between flex-wrap items-start gap-3">
        <div>
          <p class="font-semibold text-lg">${tx.members?.first_name || ''} ${tx.members?.last_name || ''}</p>
          <p class="text-sm text-gray-500">‡∏Å‡∏•‡∏∏‡πà‡∏°: ${tx.members?.group_name || '-'}</p>
          <p class="text-sm mt-1">‡∏´‡∏∏‡πâ‡∏ô: <b>${tx.shares}</b> ‡∏´‡∏ô‡πà‡∏ß‡∏¢ ‚Ä¢ ‡∏¢‡∏≠‡∏î: <b>${Number(tx.amount).toLocaleString()}</b> ‡∏ö‡∏≤‡∏ó</p>
          <span class="status ${statusClass}">${tx.status}</span>
          <p class="text-xs text-gray-400 mt-2">${new Date(tx.created_at).toLocaleString("th-TH")}</p>
        </div>
        <div class="flex flex-wrap gap-2 justify-end">
          ${tx.proof_url ? `<a href="${tx.proof_url}" target="_blank" class="text-blue-600 underline text-sm">üì∑ ‡∏î‡∏π‡∏™‡∏•‡∏¥‡∏õ</a>` : ""}
          ${tx.status === "slip_uploaded" ? `
            <button class="btn btn-approve" onclick="approveTx('${tx.id}', '${tx.line_user_id}', '${tx.members?.first_name || ''} ${tx.members?.last_name || ''}', ${tx.amount})">‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
            <button class="btn btn-reject" onclick="rejectTx('${tx.id}', '${tx.line_user_id}', '${tx.members?.first_name || ''} ${tx.members?.last_name || ''}', ${tx.amount})">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          ` : ""}
        </div>
      </div>
    `;
    list.appendChild(div);
  });
}

/* Approve */
async function approveTx(id, userId, name, amount) {
  const { isConfirmed } = await Swal.fire({
    title: "‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£?",
    html: `<b>${name}</b><br>‡∏¢‡∏≠‡∏î ${amount.toLocaleString()} ‡∏ö‡∏≤‡∏ó`,
    icon: "question",
    showCancelButton: true,
    confirmButtonText: "‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥",
    cancelButtonText: "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å",
    confirmButtonColor: "#16a34a"
  });
  if (!isConfirmed) return;

  const { error } = await supabase.from("transactions")
    .update({ status: "approved", approved_at: new Date().toISOString() })
    .eq("id", id);

  if (error) return Swal.fire("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", error.message, "error");

  await fetch(FUNCTION_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      userId,
      memberName: name,
      amount,
      mode: "approved_success"
    })
  });

  Swal.fire("‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡πâ‡∏ß", "success");
  loadTransactions();
}

/* Reject */
async function rejectTx(id, userId, name, amount) {
  const { value: reason } = await Swal.fire({
    title: "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£?",
    input: "text",
    inputPlaceholder: "‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏• (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)",
    showCancelButton: true,
    confirmButtonText: "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô",
    cancelButtonText: "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å",
    confirmButtonColor: "#dc2626"
  });
  if (reason === undefined) return;

  const { error } = await supabase.from("transactions")
    .update({ status: "rejected", reason })
    .eq("id", id);

  if (error) return Swal.fire("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", error.message, "error");

  await fetch(FUNCTION_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      userId,
      memberName: name,
      amount,
      reason,
      mode: "rejected_slip"
    })
  });

  Swal.fire("‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß", "‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢", "success");
  loadTransactions();
}

/* Init */
document.getElementById("refreshBtn").onclick = () => loadTransactions();
document.getElementById("searchInput").oninput = e => loadTransactions(e.target.value);
loadTransactions();
</script>
</body>
</html>
